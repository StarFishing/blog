<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>webworker | XiaoXin</title>
    <meta name="description" content="webworkerJavaScript多线程方案">
    <link rel="shortcut icon" href="/blog/favicon.ico">
  <meta name="referrer" content="no-referrer">
    <meta name="keywords" content="webworker JavaScript 多线程方案">
    <link rel="preload" href="/blog/assets/css/0.styles.c98d2fd1.css" as="style"><link rel="preload" href="/blog/assets/js/app.2ae5fea5.js" as="script"><link rel="preload" href="/blog/assets/js/2.6a053b7f.js" as="script"><link rel="preload" href="/blog/assets/js/28.7899db47.js" as="script"><link rel="preload" href="/blog/assets/js/4.2282b1d2.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.24a80492.js"><link rel="prefetch" href="/blog/assets/js/11.15dd0e81.js"><link rel="prefetch" href="/blog/assets/js/12.80be22dc.js"><link rel="prefetch" href="/blog/assets/js/13.8f3eea23.js"><link rel="prefetch" href="/blog/assets/js/14.4a737e05.js"><link rel="prefetch" href="/blog/assets/js/15.eb07cf8a.js"><link rel="prefetch" href="/blog/assets/js/16.36d73765.js"><link rel="prefetch" href="/blog/assets/js/17.17bc1d4d.js"><link rel="prefetch" href="/blog/assets/js/18.dc604255.js"><link rel="prefetch" href="/blog/assets/js/19.dba65164.js"><link rel="prefetch" href="/blog/assets/js/20.b1e13490.js"><link rel="prefetch" href="/blog/assets/js/21.6661e953.js"><link rel="prefetch" href="/blog/assets/js/22.b46aff83.js"><link rel="prefetch" href="/blog/assets/js/23.f9a4866a.js"><link rel="prefetch" href="/blog/assets/js/24.abc1ee8e.js"><link rel="prefetch" href="/blog/assets/js/25.5c6de7f7.js"><link rel="prefetch" href="/blog/assets/js/26.f0a361d6.js"><link rel="prefetch" href="/blog/assets/js/27.170936fa.js"><link rel="prefetch" href="/blog/assets/js/29.a7194b2b.js"><link rel="prefetch" href="/blog/assets/js/3.ebad0fee.js"><link rel="prefetch" href="/blog/assets/js/30.b2dee036.js"><link rel="prefetch" href="/blog/assets/js/31.c1603b7d.js"><link rel="prefetch" href="/blog/assets/js/32.9b4872ae.js"><link rel="prefetch" href="/blog/assets/js/33.0c4a6762.js"><link rel="prefetch" href="/blog/assets/js/34.216a6e8c.js"><link rel="prefetch" href="/blog/assets/js/35.c4da4fba.js"><link rel="prefetch" href="/blog/assets/js/36.4004ae2a.js"><link rel="prefetch" href="/blog/assets/js/37.970402d3.js"><link rel="prefetch" href="/blog/assets/js/38.5940f18d.js"><link rel="prefetch" href="/blog/assets/js/39.a9f7a9d7.js"><link rel="prefetch" href="/blog/assets/js/40.cab95d99.js"><link rel="prefetch" href="/blog/assets/js/41.c43504e7.js"><link rel="prefetch" href="/blog/assets/js/42.fea032c4.js"><link rel="prefetch" href="/blog/assets/js/43.d981b84c.js"><link rel="prefetch" href="/blog/assets/js/44.e469946c.js"><link rel="prefetch" href="/blog/assets/js/45.498af734.js"><link rel="prefetch" href="/blog/assets/js/46.5c5381de.js"><link rel="prefetch" href="/blog/assets/js/47.ade54cb1.js"><link rel="prefetch" href="/blog/assets/js/48.543817c4.js"><link rel="prefetch" href="/blog/assets/js/49.170032f2.js"><link rel="prefetch" href="/blog/assets/js/5.bbd49a80.js"><link rel="prefetch" href="/blog/assets/js/50.fdcebebc.js"><link rel="prefetch" href="/blog/assets/js/51.4688ae90.js"><link rel="prefetch" href="/blog/assets/js/52.2f859e2a.js"><link rel="prefetch" href="/blog/assets/js/53.46f20752.js"><link rel="prefetch" href="/blog/assets/js/54.8c4e2bde.js"><link rel="prefetch" href="/blog/assets/js/55.966bf42b.js"><link rel="prefetch" href="/blog/assets/js/56.93296c52.js"><link rel="prefetch" href="/blog/assets/js/57.c0e84a0a.js"><link rel="prefetch" href="/blog/assets/js/58.9c4fac4f.js"><link rel="prefetch" href="/blog/assets/js/59.18ed476c.js"><link rel="prefetch" href="/blog/assets/js/6.3b02335f.js"><link rel="prefetch" href="/blog/assets/js/60.e3ca94f3.js"><link rel="prefetch" href="/blog/assets/js/61.d40e0732.js"><link rel="prefetch" href="/blog/assets/js/62.952d91f1.js"><link rel="prefetch" href="/blog/assets/js/63.03715906.js"><link rel="prefetch" href="/blog/assets/js/64.6dce55d6.js"><link rel="prefetch" href="/blog/assets/js/65.fea30c40.js"><link rel="prefetch" href="/blog/assets/js/66.21bee15e.js"><link rel="prefetch" href="/blog/assets/js/7.64ef9703.js"><link rel="prefetch" href="/blog/assets/js/8.c33961b5.js"><link rel="prefetch" href="/blog/assets/js/9.61bba5ba.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.c98d2fd1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">XiaoXin</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/HTML+CSS/" class="nav-link">HTML+CSS</a></div><div class="nav-item"><a href="/blog/JavaScript/" class="nav-link router-link-active">JavaScript</a></div><div class="nav-item"><a href="/blog/React/" class="nav-link">React</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/Vue/VuePress/" class="nav-link">VuePress</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/electron/" class="nav-link">electron</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/vue官方文档解读/" class="nav-link">vue官方文档解读</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/关于双向绑定的探索/" class="nav-link">关于双向绑定的探索</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/源码学习/" class="nav-link">源码学习</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/问题记录/" class="nav-link">问题记录</a></li></ul></div></div><div class="nav-item"><a href="/blog/命名规范/" class="nav-link">命名规范</a></div><div class="nav-item"><a href="/blog/图床/" class="nav-link">图床</a></div><div class="nav-item"><a href="/blog/大前端/" class="nav-link">大前端</a></div> <a href="https://github.com/starfishing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/HTML+CSS/" class="nav-link">HTML+CSS</a></div><div class="nav-item"><a href="/blog/JavaScript/" class="nav-link router-link-active">JavaScript</a></div><div class="nav-item"><a href="/blog/React/" class="nav-link">React</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/Vue/VuePress/" class="nav-link">VuePress</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/electron/" class="nav-link">electron</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/vue官方文档解读/" class="nav-link">vue官方文档解读</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/关于双向绑定的探索/" class="nav-link">关于双向绑定的探索</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/源码学习/" class="nav-link">源码学习</a></li><li class="dropdown-item"><!----> <a href="/blog/Vue/问题记录/" class="nav-link">问题记录</a></li></ul></div></div><div class="nav-item"><a href="/blog/命名规范/" class="nav-link">命名规范</a></div><div class="nav-item"><a href="/blog/图床/" class="nav-link">图床</a></div><div class="nav-item"><a href="/blog/大前端/" class="nav-link">大前端</a></div> <a href="https://github.com/starfishing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/blog/JavaScript/" class="sidebar-link">笔记</a></li><li><a href="/blog/JavaScript/Asyncawait和Promise的不为人知的秘密.html" class="sidebar-link">【译】Async/await和Promise的不为人知的秘密</a></li><li><a href="/blog/JavaScript/ES6、ES7、ES8、ES9、ES10新特性一览.html" class="sidebar-link">ES6、ES7、ES8、ES9、ES10新特性一览</a></li><li><a href="/blog/JavaScript/JS中AMD、CMD、CommonJS、ES6 Module的区别.html" class="sidebar-link">JS 中 AMD、CMD、CommonJS、ES6 Module 的区别</a></li><li><a href="/blog/JavaScript/JS实现双向链表.html" class="sidebar-link">JS实现双链表</a></li><li><a href="/blog/JavaScript/JS类型隐式转换.html" class="sidebar-link">JS 类型隐式转换</a></li><li><a href="/blog/JavaScript/JavaScript 执行机制.html" class="sidebar-link">JavaScript 执行机制</a></li><li><a href="/blog/JavaScript/JavaScript 数据类型与类型判断详解.html" class="sidebar-link">JavaScript 数据类型与类型判断详解</a></li><li><a href="/blog/JavaScript/Symbol.iterator.html" class="sidebar-link">Symbol.iterator</a></li><li><a href="/blog/JavaScript/asyncawait遇到map和reduce.html" class="sidebar-link">async/await遇到map和reduce</a></li><li><a href="/blog/JavaScript/js利用H5的requestAnimationFrame() API实现动画效果.html" class="sidebar-link">requestAnimationFrame() API 实现动画效果</a></li><li><a href="/blog/JavaScript/webworker.html" class="active sidebar-link">webworker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#web-workers-api" class="sidebar-link">Web Workers API</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#专用-worker" class="sidebar-link">专用 worker</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#worker-特性检测" class="sidebar-link">worker 特性检测</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#生成一个专用-worker" class="sidebar-link">生成一个专用 worker</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#专用-worker-中消息的接收和发送" class="sidebar-link">专用 worker 中消息的接收和发送</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#终止-worker" class="sidebar-link">终止 worker</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#处理错误" class="sidebar-link">处理错误</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#共享-worker" class="sidebar-link">共享 worker</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#生成一个共享-worker" class="sidebar-link">生成一个共享 worker</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#共享-worker-中消息的接收和发送" class="sidebar-link">共享 worker 中消息的接收和发送</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#传递数据的例子" class="sidebar-link">传递数据的例子</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#通过转让所有权-可转让对象-来传递数据" class="sidebar-link">通过转让所有权(可转让对象)来传递数据</a></li><li class="sidebar-sub-header"><a href="/blog/JavaScript/webworker.html#在后台执行运算节" class="sidebar-link">在后台执行运算节</a></li></ul></li><li><a href="/blog/JavaScript/不定参数.html" class="sidebar-link">关于 Add(2)(3)问题</a></li><li><a href="/blog/JavaScript/动态创建 Script标签.html" class="sidebar-link">动态创建 Script 标签</a></li><li><a href="/blog/JavaScript/动态换肤.html" class="sidebar-link">关于动态换肤的解决方案</a></li><li><a href="/blog/JavaScript/原型与原型链.html" class="sidebar-link">原型与原型链</a></li><li><a href="/blog/JavaScript/反思闭包.html" class="sidebar-link">反思闭包</a></li><li><a href="/blog/JavaScript/在JS如何让同一个值连等于为真.html" class="sidebar-link">在 JS 中，如何让(a===1 &amp;&amp; a===2 &amp;&amp; a === 3)(严格相等)的值为 true</a></li><li><a href="/blog/JavaScript/将嵌套数组转换为一维数组.html" class="sidebar-link">将嵌套数组转换为一维数组</a></li><li><a href="/blog/JavaScript/带你用Node了解JSONP实现原理.html" class="sidebar-link">带你用 Node 了解 JSONP 实现原理</a></li><li><a href="/blog/JavaScript/观察者模式.html" class="sidebar-link">实现观察者模式</a></li><li><a href="/blog/JavaScript/页面跳转以及刷新常用实现方式.html" class="sidebar-link">页面跳转以及刷新常用实现方式</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webworker-javascript-多线程方案"><a href="#webworker-javascript-多线程方案" aria-hidden="true" class="header-anchor">#</a> webworker-JavaScript 多线程方案</h1> <blockquote><p>Web Worker 为 Web 内容在后台线程中运行脚本提供了一种简单的方法。线程可以执行任务而不干扰用户界面。此外，他们可以使用 XMLHttpRequest 执行 I/O (尽管 responseXML 和 channel 属性总是为空)。一旦创建， 一个 worker 可以将消息发送到创建它的 JavaScript 代码, 通过将消息发布到该代码指定的事件处理程序（反之亦然）。本文提供了有关使用 Web Worker 的详细介绍。</p></blockquote> <h2 id="web-workers-api"><a href="#web-workers-api" aria-hidden="true" class="header-anchor">#</a> Web Workers API</h2> <p>一个 worker 是使用一个构造函数创建的一个对象(e.g. Worker()) 运行一个命名的 JavaScript 文件 - 这个文件包含将在工作线程中运行的代码; workers 运行在另一个全局上下文中,不同于当前的 window. 因此，使用 window 快捷方式获取当前全局的范围 (而不是 self) 在一个 Worker 内将返回错误。</p> <p>在专用 workers 的情况下，DedicatedWorkerGlobalScope 对象代表了 worker 的上下文（专用 workers 是指标准 worker 仅在单一脚本中被使用；共享 worker 的上下文是 SharedWorkerGlobalScope 对象）。一个专用 worker 仅仅能被首次生成它的脚本使用，而共享 worker 可以同时被多个脚本使用。</p> <p>在 worker 线程中你可以运行任何你喜欢的代码，不过有一些例外情况。比如：<strong>在 worker 内，不能直接操作 DOM 节点，也不能使用 window 对象的默认方法和属性</strong>。然而你可以使用大量 window 对象之下的东西，包括 WebSockets，IndexedDB 以及 FireFox OS 专用的 Data Store API 等数据存储机制。查看 Functions and classes available to workers 获取详情。</p> <p>workers 和主线程间的数据传递通过这样的消息机制进行——双方都使用 postMessage()方法发送各自的消息，使用 onmessage 事件处理函数来响应消息（消息被包含在 Message 事件的 data 属性中）。这个过程中数据并不是被共享而是被复制。</p> <p>只要运行在同源的父页面中，workers 可以依次生成新的 workers；并且可以使用 XMLHttpRequest 进行网络 I/O，responseXML 和 XMLHttpRequest 的通道属性一直返回 null 的情况除外。</p> <h2 id="专用-worker"><a href="#专用-worker" aria-hidden="true" class="header-anchor">#</a> 专用 worker</h2> <p>如前文所述，一个专用 worker 仅仅能被生成它的脚本所使用。这一部分将探讨 专用 worker 基础示例 (运行专用 worker) 中的 JavaScript 代码：将你输入的 2 个数字作乘法。输入的数字会发送给一个专用 worker，由专用 worker 作乘法后，再返回给页面进行展示。</p> <p>这个例子很小，但是我们决定在保持简单的同时向你介绍基础的 worker 概念。更多的细节会在之后的文章中进行讲解。</p> <h2 id="worker-特性检测"><a href="#worker-特性检测" aria-hidden="true" class="header-anchor">#</a> worker 特性检测</h2> <p>为了更好的错误处理控制以及向下兼容，将你的 worker 运行代码包裹在以下代码中是一个很好的想法(main.js)：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>Worker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="生成一个专用-worker"><a href="#生成一个专用-worker" aria-hidden="true" class="header-anchor">#</a> 生成一个专用 worker</h2> <p>创建一个新的 worker 很简单。你需要做的是调用 Worker() 的构造器，指定一个脚本的 URI 来执行 worker 线程（main.js）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'worker.js'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="专用-worker-中消息的接收和发送"><a href="#专用-worker-中消息的接收和发送" aria-hidden="true" class="header-anchor">#</a> 专用 worker 中消息的接收和发送</h2> <p>workers 的魔法通过 postMessage() 方法和 onmessage 事件处理函数生效。向一个 worker 发送消息需要这样做（main.js）：</p> <div class="language-js extra-class"><pre class="language-js"><code>first<span class="token punctuation">.</span><span class="token function-variable function">onchange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  myWorker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">[</span>first<span class="token punctuation">.</span>value<span class="token punctuation">,</span> second<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Message posted to worker'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
second<span class="token punctuation">.</span><span class="token function-variable function">onchange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  myWorker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">[</span>first<span class="token punctuation">.</span>value<span class="token punctuation">,</span> second<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Message posted to worker'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码中变量 first 和 second 代表 2 个<input>元素；它们当中任意一个的值发生改变时，myWorker.postMessage([first.value,second.value])会将这 2 个值组成数组发送给 worker。你可以在消息中发送许多你想发送的东西。</p> <p>在 worker 中接收到消息后，我们可以写这样一个事件处理函数代码作为响应（worker.js）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Message received from main script'</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> workerResult <span class="token operator">=</span> <span class="token string">'Result: '</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> e<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Posting message back to main script'</span><span class="token punctuation">)</span>
  <span class="token function">postMessage</span><span class="token punctuation">(</span>workerResult<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>onmessage 处理函数允许我们在任何时刻，一旦接收到消息就可以执行一些代码，代码中消息本身作为事件的 data 属性进行使用。这里我们简单的对这 2 个数字作乘法处理并再次使用 postMessage()方法，将结果回传给主线程。</p> <p>回到主线程，我们再次使用 onmessage 以响应 worker 回传的消息：</p> <div class="language-js extra-class"><pre class="language-js"><code>myWorker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  result<span class="token punctuation">.</span>textContent <span class="token operator">=</span> e<span class="token punctuation">.</span>data
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Message received from worker'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这里我们获取消息事件的 data，并且将它设置为 result 的 textContent，所以用户可以直接看到运算的结果。</p> <blockquote><p><strong>注意：</strong> 在主线程中使用时，onmessage 和 postMessage() 必须挂在 worker 对象上，而在 worker 中使用时不用这样做。原因是，在 worker 内部，worker 是有效的全局作用域。当一个消息在主线程和 worker 之间传递时，它被复制或者转移了，而不是共享。</p></blockquote> <h2 id="终止-worker"><a href="#终止-worker" aria-hidden="true" class="header-anchor">#</a> 终止 worker</h2> <p>如果你需要从主线程中立刻终止一个运行中的 worker，可以调用 worker 的 terminate 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>myWorker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>worker 线程会被立即杀死，不会有任何机会让它完成自己的操作或清理工作。</p> <p>而在 worker 线程中，workers 也可以调用自己的 close 方法进行关闭：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="处理错误"><a href="#处理错误" aria-hidden="true" class="header-anchor">#</a> 处理错误</h2> <p>当 worker 出现运行中错误时，它的 onerror 事件处理函数会被调用。它会收到一个扩展了 ErrorEvent 接口的名为 error 的事件。</p> <p>该事件不会冒泡并且可以被取消；为了防止触发默认动作，worker 可以调用错误事件的 preventDefault()方法。</p> <p>错误事件有以下三个用户关心的字段：</p> <p><strong>message</strong></p> <p>可读性良好的错误消息。</p> <p><strong>filename</strong></p> <p>发生错误的脚本文件名。</p> <p><strong>lineno</strong></p> <p>发生错误时所在脚本文件的行号。</p> <p><strong>生成 subworker</strong></p> <p>如果需要的话 worker 能够生成更多的 worker。这就是所谓的 subworker，它们必须托管在同源的父页面内。而且，subworker 解析 URI 时会相对于父 worker 的地址而不是自身页面的地址。这使得 worker 更容易记录它们之间的依赖关系。</p> <p><strong>引入脚本与库</strong></p> <p>Worker 线程能够访问一个全局函数 importScripts()来引入脚本，该函数接受 0 个或者多个 URI 作为参数来引入资源；以下例子都是合法的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">/* 什么都不引入 */</span>
<span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">'foo.js'</span><span class="token punctuation">)</span> <span class="token comment">/* 只引入 &quot;foo.js&quot; */</span>
<span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">'foo.js'</span><span class="token punctuation">,</span> <span class="token string">'bar.js'</span><span class="token punctuation">)</span> <span class="token comment">/* 引入两个脚本 */</span>
</code></pre></div><p>浏览器加载并运行每一个列出的脚本。每个脚本中的全局对象都能够被 worker 使用。如果脚本无法加载，将抛出 NETWORK_ERROR 异常，接下来的代码也无法执行。而之前执行的代码(包括使用 window.setTimeout() 异步执行的代码)依然能够运行。importScripts() <strong>之后</strong>的函数声明依然会被保留，因为它们始终会在其他代码之前运行。</p> <blockquote><p><strong>注意：</strong> 脚本的下载顺序不固定，但执行时会按照传入 importScripts() 中的文件名顺序进行。这个过程是同步完成的；直到所有脚本都下载并运行完毕，importScripts() 才会返回。</p></blockquote> <h2 id="共享-worker"><a href="#共享-worker" aria-hidden="true" class="header-anchor">#</a> 共享 worker</h2> <p>一个共享 worker 可以被多个脚本使用——即使这些脚本正在被不同的 window、iframe 或者 worker 访问。这一部分，我们会讨论共享 worker 基础示例（运行共享 worker）中的 javascript 代码：该示例与专用 worker 基础示例非常相像，只是有 2 个可用函数被存放在不同脚本文件中：两数相乘函数，以及求平方函数。这两个脚本用同一个 worker 来完成实际需要的运算。</p> <p>这里，我们关注一下专用 worker 和共享 worker 之间的区别。在这个示例中有 2 个 HTML 页面，每个页面所包含的 javascript 代码使用的是同一个 worker。</p> <blockquote><p>**注意：**如果共享 worker 可以被多个浏览上下文调用，所有这些浏览上下文必须属于同源（相同的协议，主机和端口号）。在 Firefox 中, 共享 worker 不能被私有和非私有 window 对象的 document 所共享 (bug 1177621)。</p></blockquote> <h2 id="生成一个共享-worker"><a href="#生成一个共享-worker" aria-hidden="true" class="header-anchor">#</a> 生成一个共享 worker</h2> <p>生成一个新的共享 worker 与生成一个专用 worker 非常相似，只是构造器的名字不同（查看 index.html 和 index2.html）——生成共享 worker 的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'worker.js'</span><span class="token punctuation">)</span>
</code></pre></div><p>一个非常大的区别在于，与一个共享 worker 通信必须通过端口对象——一个确切的打开的端口供脚本与 worker 通信（在专用 worker 中这一部分是隐式进行的）。</p> <p>在传递消息之前，端口连接必须被显式的打开，打开方式是使用 onmessage 事件处理函数或者 start()方法。示例中的 multiply.js 和 worker.js 文件没有调用了 start()方法，这些调用并不那么重要是因为 onmessage 事件处理函数正在被使用。start()方法的调用只在一种情况下需要，那就是消息事件被 addEventListener()方法使用。</p> <p>在使用 start()方法打开端口连接时，如果父级线程和 worker 线程需要双向通信，那么它们都需要调用 start()方法。</p> <div class="language-js extra-class"><pre class="language-js"><code>myWorker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 父级线程中的调用</span>
port<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// worker线程中的调用, 假设port变量代表一个端口</span>
</code></pre></div><h2 id="共享-worker-中消息的接收和发送"><a href="#共享-worker-中消息的接收和发送" aria-hidden="true" class="header-anchor">#</a> 共享 worker 中消息的接收和发送</h2> <p>现在，消息可以像之前那样发送到 worker 了，但是 postMessage() 方法必须被端口对象调用（你会再一次看到 multiply.js 和 square.js 中相似的结构）：</p> <div class="language-js extra-class"><pre class="language-js"><code>squareNumber<span class="token punctuation">.</span><span class="token function-variable function">onchange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  myWorker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">[</span>squareNumber<span class="token punctuation">.</span>value<span class="token punctuation">,</span> squareNumber<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Message posted to worker'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>回到 worker 中，这里也有一些些复杂（worker.js）:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">onconnect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> port <span class="token operator">=</span> e<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> workerResult <span class="token operator">=</span> <span class="token string">'Result: '</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> e<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>workerResult<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先，当一个端口连接被创建时（例如：在父级线程中，设置 onmessage 事件处理函数，或者显式调用 start()方法时），使用 onconnect 事件处理函数来执行代码。</p> <p>使用事件的 ports 属性来获取端口并存储在变量中。</p> <p>然后，为端口添加一个消息处理函数用来做运算并回传结果给主线程。在 worker 线程中设置此消息处理函数也会隐式的打开与主线程的端口连接，因此这里跟前文一样，对 port.start()的调用也是不必要的。</p> <p>最后，回到主脚本，我们处理消息（你会又一次看到 multiply.js 和 square.js 中相似的结构）：</p> <div class="language-js extra-class"><pre class="language-js"><code>myWorker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  result2<span class="token punctuation">.</span>textContent <span class="token operator">=</span> e<span class="token punctuation">.</span>data
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Message received from worker'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当一条消息通过端口回到 worker，我们检查结果的类型，然后将运算结果放入结果段落中合适的地方。</p> <h1 id="关于线程安全"><a href="#关于线程安全" aria-hidden="true" class="header-anchor">#</a> 关于线程安全</h1> <p>Worker 接口会生成真正的操作系统级别的线程，如果你不太小心，那么并发会对你的代码产生有趣的影响。然而，对于 web worker 来说，与其他线程的通信点会被很小心的控制，这意味着你很难引起并发问题。你没有办法去访问非线程安全的组件或者是 DOM，此外你还需要通过序列化对象来与线程交互特定的数据。所以你要是不费点劲儿，还真搞不出错误来</p> <h1 id="内容安全策略"><a href="#内容安全策略" aria-hidden="true" class="header-anchor">#</a> 内容安全策略</h1> <p>有别于创建它的 document 对象，worker 有它自己的执行上下文。因此普遍来说，worker 并不受限于创建它的 document（或者父级 worker）的内容安全策略。我们来举个例子，假设一个 document 有如下头部声明：</p> <p>Content-Security-Policy: script-src 'self'</p> <p>这个声明有一部分作用在于，禁止它内部包含的脚本代码使用 eval()方法。然而，如果脚本代码创建了一个 worker，在 worker 上下文中执行的代码却是可以使用 eval()的。</p> <p>为了给 worker 指定内容安全策略，必须为发送 worker 代码的请求本身加上一个 内容安全策略。</p> <p>有一个例外情况，即 worker 脚本的源如果是一个全局性的唯一的标识符（例如，它的 URL 指定了数据模式或者 blob），worker 则会继承创建它的 document 或者 worker 的 CSP（Content security policy 内容安全策略）。</p> <h1 id="worker-中数据的接收与发送：详细介绍节"><a href="#worker-中数据的接收与发送：详细介绍节" aria-hidden="true" class="header-anchor">#</a> worker 中数据的接收与发送：详细介绍节</h1> <p>在主页面与 worker 之间传递的数据是通过<strong>拷贝</strong>，而不是共享来完成的。传递给 worker 的对象需要经过序列化，接下来在另一端还需要反序列化。页面与 worker **不会共享同一个实例，<strong>最终的结果就是在每次通信结束时生成了数据的</strong>一个副本。**大部分浏览器使用结构化拷贝来实现该特性。</p> <p>在往下进行之前，出于教学的目的，让我们创建一个名为 emulateMessage() 的函数，它将模拟在从 worker 到主页面(反之亦然)的通信过程中，变量的「<em>拷贝而非共享</em>」行为</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">emulateMessage</span><span class="token punctuation">(</span><span class="token parameter">vVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">'('</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>vVal<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Tests</span>
<span class="token comment">// test #1</span>
<span class="token keyword">var</span> example1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Number</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> example1<span class="token punctuation">)</span> <span class="token comment">// object</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token function">emulateMessage</span><span class="token punctuation">(</span>example1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// number</span>

<span class="token comment">// test #2</span>
<span class="token keyword">var</span> example2 <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> example2<span class="token punctuation">)</span> <span class="token comment">// boolean</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token function">emulateMessage</span><span class="token punctuation">(</span>example2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// boolean</span>

<span class="token comment">// test #3</span>
<span class="token keyword">var</span> example3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> example3<span class="token punctuation">)</span> <span class="token comment">// object</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token function">emulateMessage</span><span class="token punctuation">(</span>example3<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// string</span>

<span class="token comment">// test #4</span>
<span class="token keyword">var</span> example4 <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'John Smith'</span><span class="token punctuation">,</span>
  age<span class="token punctuation">:</span> <span class="token number">43</span>
<span class="token punctuation">}</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> example4<span class="token punctuation">)</span> <span class="token comment">// object</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token function">emulateMessage</span><span class="token punctuation">(</span>example4<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// object</span>

<span class="token comment">// test #5</span>
<span class="token keyword">function</span> <span class="token function">Animal</span><span class="token punctuation">(</span><span class="token parameter">sType<span class="token punctuation">,</span> nAge</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> sType
  <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> nAge
<span class="token punctuation">}</span>
<span class="token keyword">var</span> example5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token string">'Cat'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token function">alert</span><span class="token punctuation">(</span>example5<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span> <span class="token comment">// Animal</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token function">emulateMessage</span><span class="token punctuation">(</span>example5<span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">)</span> <span class="token comment">// Object</span>
</code></pre></div><p>拷贝而并非共享的那个值称为 <em>消息</em>。再来谈谈 worker，你可以使用 postMessage() 将消息传递给主线程或从主线程传送回来。message 事件的 data 属性就包含了从 worker 传回来的数据。</p> <p><strong>example.html</strong>: (主页面):</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> myWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'my_task.js'</span><span class="token punctuation">)</span>
myWorker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">oEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Worker said : '</span> <span class="token operator">+</span> oEvent<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
myWorker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'ali'</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>my_task.js</strong> (worker):</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;I'm working before postMessage('ali').&quot;</span><span class="token punctuation">)</span>
<span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">oEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'Hi '</span> <span class="token operator">+</span> oEvent<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结构化拷贝算法可以接收 JSON 数据以及一些 JSON 不能表示的数据——比如循环引用</p> <h2 id="传递数据的例子"><a href="#传递数据的例子" aria-hidden="true" class="header-anchor">#</a> 传递数据的例子</h2> <p>例子 #1： 创建一个通用的异步 eval()</p> <p>下面这个例子介绍了，如何在 worker 内使用 eval() 来按顺序执行<strong>异步的</strong>任何种类的 JavaScript 代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Syntax: asyncEval(code[, listener])</span>
<span class="token keyword">var</span> asyncEval <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">var</span> aListeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>；
 <span class="token keyword">var</span> oParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&quot;data:text/javascript;charset=US-ASCII,onmessage%20%3D%20function%20%28oEvent%29%20%7B%0A%09postMessage%28%7B%0A%09%09%22id%22%3A%20oEvent.data.id%2C%0A%09%09%22evaluated%22%3A%20eval%28oEvent.data.code%29%0A%09%7D%29%3B%0A%7D&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 oParser<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">oEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>aListeners<span class="token punctuation">[</span>oEvent<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> aListeners<span class="token punctuation">[</span>oEvent<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">(</span>oEvent<span class="token punctuation">.</span>data<span class="token punctuation">.</span>evaluated<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
 <span class="token keyword">delete</span> aListeners<span class="token punctuation">[</span>oEvent<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sCode<span class="token punctuation">,</span> fListener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 aListeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fListener <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 oParser<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 <span class="token string">&quot;id&quot;</span><span class="token punctuation">:</span> aListeners<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
 <span class="token string">&quot;code&quot;</span><span class="token punctuation">:</span> sCode
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>data URL 相当于一个网络请求，它有如下返回：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">oEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> oEvent<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    evaluated<span class="token punctuation">:</span> <span class="token function">eval</span><span class="token punctuation">(</span>oEvent<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例使用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// asynchronous alert message...</span>
<span class="token function">asyncEval</span><span class="token punctuation">(</span><span class="token string">'3 + 2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sMessage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'3 + 2 = '</span> <span class="token operator">+</span> sMessage<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// asynchronous print message...</span>
<span class="token function">asyncEval</span><span class="token punctuation">(</span><span class="token string">'&quot;Hello World!!!&quot;'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sHTML</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>sHTML<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// asynchronous void...</span>
<span class="token function">asyncEval</span><span class="token punctuation">(</span>
  <span class="token string">'(function () {\n\tvar oReq = new XMLHttpRequest();\n\toReq.open(&quot;get&quot;, &quot;http://www.mozilla.org/&quot;, false);\n\toReq.send(null);\n\treturn oReq.responseText;\n})()'</span>
<span class="token punctuation">)</span>
</code></pre></div><p>例子 #2：传输 JSON 的高级方式和创建一个交换系统</p> <p>如果你需要传输非常复杂的数据，还要同时在主页与 Worker 内调用多个方法，那么可以考虑创建一个类似下面的系统。</p> <p>首先，我们创建一个 QueryableWorker 的类，它接收 worker 的 url、一个默认侦听函数、和一个错误处理函数作为参数，这个类将会记录所有的侦听的列表并且帮助我们与 worker 进行通信。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">QueryableWorker</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> defaultListener<span class="token punctuation">,</span> onError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
    worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span>
    listeners <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>defaultListener <span class="token operator">=</span> defaultListener <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>onError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    worker<span class="token punctuation">.</span>onerror <span class="token operator">=</span> onError
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">postMessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">terminate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    worker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>紧接着，我们写出新增和删除侦听的方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">addListeners</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  listeners<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> listener
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">removeListeners</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">delete</span> listeners<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们让 worker 处理 2 个这样的简单操作：区别 2 个数字并在 3 秒后弹框提示。为了完成这个操作，我们首先实现一个 sendQuery 方法，该方法可以查询 worker 是否真正有我们所需要的对应方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* 
 This functions takes at least one argument, the method name we want to query.
 Then we can pass in the arguments that the method needs.
 */</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">sendQuery</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'QueryableWorker.sendQuery takes at least one argument'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    queryMethod<span class="token punctuation">:</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    queryArguments<span class="token punctuation">:</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们以 onmessage 方法作为 QueryableWorker 的结尾。如果 worker 有我们所需要的对应的方法，它就会返回相对应的侦听方法的名字以及所需要的参数，我们只需要在侦听列表 listeners 中找到它：</p> <div class="language-js extra-class"><pre class="language-js"><code>worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    event<span class="token punctuation">.</span>data <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">&amp;&amp;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'queryMethodListener'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'queryMethodArguments'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listeners<span class="token punctuation">[</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>queryMethodListener<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
      instance<span class="token punctuation">,</span>
      event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>queryMethodArguments
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defaultListener</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在回到 worker 中。首先我们需要一个能够完成这 2 个操作的方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> queryableFunctions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getDifference</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reply</span><span class="token punctuation">(</span><span class="token string">'printStuff'</span><span class="token punctuation">,</span> a <span class="token operator">-</span> b<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">waitSomeTime</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reply</span><span class="token punctuation">(</span><span class="token string">'doAlert'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'seconds'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">reply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'reply - takes at least one argument'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    queryMethodListener<span class="token punctuation">:</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    queryMethodArguments<span class="token punctuation">:</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/* This method is called when main page calls QueryWorker's postMessage method directly*/</span>
<span class="token keyword">function</span> <span class="token function">defaultReply</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre></div><p>onmessage 方法也就很简单了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    event<span class="token punctuation">.</span>data <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">&amp;&amp;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'queryMethod'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'queryMethodArguments'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    queryableFunctions<span class="token punctuation">[</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>queryMethod<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
      self<span class="token punctuation">,</span>
      event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>queryMethodArguments
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">defaultReply</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来给出一个完整的实现:</p> <p><strong>example.html</strong> (the main page):</p> <p><img src="http://p1.pstatp.com/large/pgc-image/82bbd84b95764288877403f507dcd5fd" alt="JavaScript多线程方案：Web Workers看完即会的教程"></p> <p><strong>my_task.js</strong> (the worker):</p> <p><img src="http://p1.pstatp.com/large/pgc-image/25af9d33117b4fdea37ab2e5ebc20e4e" alt="JavaScript多线程方案：Web Workers看完即会的教程"></p> <p>这个实例中，可以对从主页面到 worker、以及 worker 到主页面之间传递的消息内容进行切换。而且属性名&quot;queryMethod&quot;, &quot;queryMethodListeners&quot;,&quot;queryMethodArguments&quot;可以是任何东西，只要它们在 QueryableWorker 和 worker 中保持一致。</p> <h2 id="通过转让所有权-可转让对象-来传递数据"><a href="#通过转让所有权-可转让对象-来传递数据" aria-hidden="true" class="header-anchor">#</a> 通过转让所有权(可转让对象)来传递数据</h2> <p>Google Chrome 17 与 Firefox 18 包含另一种性能更高的方法来将特定类型的对象(可转让对象) 传递给一个 worker/从 worker 传回 。可转让对象从一个上下文转移到另一个上下文而不会经过任何拷贝操作。这意味着当传递大数据时会获得极大的性能提升。如果你从 C/C++ 世界来，那么把它想象成按照引用传递。然而与按照引用传递不同的是，一旦对象转让，那么它在原来上下文的那个版本将不复存在。该对象的所有权被转让到新的上下文内。例如，当你将一个 ArrayBuffer 对象从主应用转让到 Worker 中，原始的 ArrayBuffer 被清除并且无法使用。它包含的内容会(完整无差的)传递给 Worker 上下文。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Create a 32MB &quot;file&quot; and fill it.</span>
<span class="token keyword">var</span> uInt8Array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token comment">// 32MB</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> uInt8Array<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  uInt8Array<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i
<span class="token punctuation">}</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>uInt8Array<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token punctuation">[</span>uInt8Array<span class="token punctuation">.</span>buffer<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="嵌入式-worker"><a href="#嵌入式-worker" aria-hidden="true" class="header-anchor">#</a> 嵌入式 worker</h1> <p>目前没有一种「官方」的方法能够像 <code>&lt;script&gt;</code> 元素一样将 worker 的代码嵌入的网页中。但是如果一个 <code>&lt;script&gt;</code> 元素没有 src 特性，并且它的 type 特性没有指定成一个可运行的 mime-type，那么它就会被认为是一个数据块元素，并且能够被 JavaScript 使用。「数据块」是 HTML5 中一个十分常见的特性，它可以携带几乎任何文本类型的数据。所以，你能够以如下方式嵌入一个 worker：</p> <p><img src="http://p3.pstatp.com/large/pgc-image/6b60a88cb70143b58ae1f86afa370da6" alt="JavaScript多线程方案：Web Workers看完即会的教程"></p> <p>现在，嵌入式 worker 已经嵌套进了一个自定义的 document.worker 属性中。</p> <p>这样也不足为奇，你仍然可以将一个函数转换为 blob，然后为这个 blob 生成 URL 对象。比如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fn2workerURL</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'('</span> <span class="token operator">+</span> fn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">')()'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'application/javascript'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>本节提供了几个如何使用 DOM worker 的例子。</p> <h2 id="在后台执行运算节"><a href="#在后台执行运算节" aria-hidden="true" class="header-anchor">#</a> 在后台执行运算节</h2> <p>worker 的一个优势在于能够执行处理器密集型的运算而不会阻塞 UI 线程。在下面的例子中，worker 用于计算斐波那契数。</p> <p>JavaScript 代码</p> <p>下面的 JavaScript 代码保存在「fibonacci.js」文件中，与下一节的 HTML 文件关联。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">function</span> <span class="token function">resultReceiver</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">postMessage</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">errorReceiver</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> event<span class="token punctuation">.</span>data
<span class="token punctuation">}</span>
<span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">postMessage</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'fibonacci.js'</span><span class="token punctuation">)</span>
    worker<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> resultReceiver
    worker<span class="token punctuation">.</span>onerror <span class="token operator">=</span> errorReceiver
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>n <span class="token operator">-</span> i<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>worker 将属性 onmessage 设置为一个函数，当 worker 对象调用 postMessage() 时该函数会接收到发送过来的信息。(注意，这么使用并不等同于定义一个同名的全局<em>变量</em> ，或是定义一个同名的<em>函数</em>。var onmessage 与 function onmessage 将会定义与该名字相同的全局属性，但是它们不会注册能够接收从创建 worker 的网页发送过来的消息的函数。) 这会启用递归，生成自己的新拷贝来处理计算的每一个循环。</p> <p>HTML 代码</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Test threads fibonacci<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>result<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'fibonacci.js'</span><span class="token punctuation">)</span>
      worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> event<span class="token punctuation">.</span>data
        <span class="token function">dump</span><span class="token punctuation">(</span><span class="token string">'Got: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      worker<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dump</span><span class="token punctuation">(</span><span class="token string">'Worker error: '</span> <span class="token operator">+</span> error<span class="token punctuation">.</span>message <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> error
      <span class="token punctuation">}</span>
      worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>网页创建了一个 div 元素，ID 为 result ， 用它来显示运算结果，然后生成 worker。在生成 worker 后，onmessage 处理函数配置为通过设置 div 元素的内容来显示运算结果，然后 onerror 处理函数被设置为 转储 错误信息。</p> <p>最后，向 worker 发送一条信息来启动它。</p> <h1 id="worker-中可用的函数和接口"><a href="#worker-中可用的函数和接口" aria-hidden="true" class="header-anchor">#</a> worker 中可用的函数和接口</h1> <p>你可以在 web worker 中使用大多数的标准 javascript 特性，包括</p> <ul><li>Navigator</li> <li>XMLHttpRequest</li> <li>Array, Date, Math, and String</li> <li>WindowTimers.setTimeout and WindowTimers.setInterval</li></ul> <p>在一个 worker 中最主要的你不能做的事情就是直接影响父页面。包括操作父页面的节点以及使用页面中的对象。你只能间接地实现，通过 DedicatedWorkerGlobalScope.postMessage 回传消息给主脚本，然后从主脚本那里执行操作或变化。</p> <h1 id="worker兼容性"><a href="#worker兼容性" aria-hidden="true" class="header-anchor">#</a> <strong>Worker</strong>兼容性</h1> <p><img src="http://p1.pstatp.com/large/pgc-image/f4aeb1b294824ab3ba86a815a33fbe2d" alt="JavaScript多线程方案：Web Workers看完即会的教程"> <div id="vcomments"></div></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">10/6/2019, 7:16:01 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/JavaScript/js利用H5的requestAnimationFrame() API实现动画效果.html" class="prev">
          requestAnimationFrame() API 实现动画效果
        </a></span> <span class="next"><a href="/blog/JavaScript/不定参数.html">
          关于 Add(2)(3)问题
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.2ae5fea5.js" defer></script><script src="/blog/assets/js/2.6a053b7f.js" defer></script><script src="/blog/assets/js/28.7899db47.js" defer></script><script src="/blog/assets/js/4.2282b1d2.js" defer></script>
  </body>
</html>
